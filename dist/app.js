!function(o){var e={};function n(s){if(e[s])return e[s].exports;var t=e[s]={i:s,l:!1,exports:{}};return o[s].call(t.exports,t,t.exports,n),t.l=!0,t.exports}n.m=o,n.c=e,n.d=function(o,e,s){n.o(o,e)||Object.defineProperty(o,e,{enumerable:!0,get:s})},n.r=function(o){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(o,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(o,"__esModule",{value:!0})},n.t=function(o,e){if(1&e&&(o=n(o)),8&e)return o;if(4&e&&"object"==typeof o&&o&&o.__esModule)return o;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:o}),2&e&&"string"!=typeof o)for(var t in o)n.d(s,t,function(e){return o[e]}.bind(null,t));return s},n.n=function(o){var e=o&&o.__esModule?function(){return o.default}:function(){return o};return n.d(e,"a",e),e},n.o=function(o,e){return Object.prototype.hasOwnProperty.call(o,e)},n.p="",n(n.s=10)}([function(o,e){o.exports=require("jsonwebtoken")},function(o,e){o.exports=require("dotenv")},function(o,e){o.exports=require("express")},function(o,e){o.exports=require("bcrypt")},function(o,e){o.exports=require("cluster")},function(o,e){o.exports=require("body-parser")},function(o,e){o.exports=require("mongodb")},function(o,e){o.exports=require("cookie-parser")},function(o,e){o.exports=require("os")},function(o,e){o.exports=require("http")},function(o,e,n){"use strict";n.r(e);var s=n(1);class t{static display(){console.log("<------------Config------------\x3e"),console.log("Production: "+t.production),console.log("Log: "+t.log),console.log("Port: "+t.port),console.log("Host: "+t.host),console.log("Secret key: "+t.secretKey),console.log("MongoDB username: "+t.mongodbUser),console.log("MongoDB password: "+t.mongodbPassword),console.log("Allowed domains count: "+t.allowedDomainsCount),console.log("Allowed domains: "+t.allowedDomains),console.log("App key: "+t.appKey),console.log("<------------Config-----------/>")}static init(){Object(s.config)({path:".env"}),t.production="true"===process.env.PRODUCTION,t.log="true"===process.env.LOG,t.port=process.env.PORT||3e3,t.host=process.env.HOST||"localhost",t.secretKey=process.env.SECRET_KEY||"",t.mongodbUser=process.env.MONGODB_USER||"",t.mongodbPassword=process.env.MONGODB_PASSWORD||"",t.allowedDomainsCount=process.env.ALLOWED_DOMAINS_COUNT||0,t.allowedDomains=[];for(var o=0;o<t.allowedDomainsCount;o++)t.allowedDomains.push(process.env["ALLOWED_DOMAIN_"+o]);t.appKey=process.env.APP_KEY||""}}t.init();var r=t,c=n(6);class l{static db(){return l.client.db("absence-manager")}static init(){const o=`mongodb+srv://${r.mongodbUser}:${r.mongodbPassword}@cluster0-oxkrf.mongodb.net/test?retryWrites=true&w=majority`;l.client=new c.MongoClient(o,{useNewUrlParser:!0,useUnifiedTopology:!0,poolSize:100}),l.client.connect()}}var a=l,i=n(2),u=n.n(i),p=n(5),d=n.n(p),g=n(7),f=n.n(g);var v=function(o,e,n){const s=o.get("origin")||"",t=o.headers["app-key"],c=!!s&&r.allowedDomains.includes(s),l=!!t&&r.appKey===t;c?(o.clientType=0,o.origin=s):l&&(o.clientType=1),(c||l)&&n()};var y=function(o,e,n){0===o.clientType?e.header("Access-Control-Allow-Origin",o.origin):e.header("Access-Control-Allow-Origin","*"),e.header("Access-Control-Allow-Credentials","true"),e.header("Access-Control-Allow-Headers","*"),n()},m=n(0),O=n.n(m);var w=function(o,e,n){const s=function(o){try{const e=O.a.verify(o,r.secretKey);return!!e&&e._id}catch(o){return!1}}(o.headers.token);o.auth=s,n()};class b{static display(){console.log("<------------Config------------\x3e"),console.log("Production: "+b.production),console.log("Log: "+b.log),console.log("Port: "+b.port),console.log("Host: "+b.host),console.log("Secret key: "+b.secretKey),console.log("MongoDB username: "+b.mongodbUser),console.log("MongoDB password: "+b.mongodbPassword),console.log("Allowed domains count: "+b.allowedDomainsCount),console.log("Allowed domains: "+b.allowedDomains),console.log("App key: "+b.appKey),console.log("<------------Config-----------/>")}static init(){Object(s.config)({path:".env"}),b.production="true"===process.env.PRODUCTION,b.log="true"===process.env.LOG,b.port=process.env.PORT||3e3,b.host=process.env.HOST||"localhost",b.secretKey=process.env.SECRET_KEY||"",b.mongodbUser=process.env.MONGODB_USER||"",b.mongodbPassword=process.env.MONGODB_PASSWORD||"",b.allowedDomainsCount=process.env.ALLOWED_DOMAINS_COUNT||0,b.allowedDomains=[];for(var o=0;o<b.allowedDomainsCount;o++)b.allowedDomains.push(process.env["ALLOWED_DOMAIN_"+o]);b.appKey=process.env.APP_KEY||""}}b.init();var h=b;var D=function(o){const{length:e,noNumbers:n,noLetters:s,noCapitalized:t}=o;var r="";n||(r+="1234567890"),s||(r+="abcdefghigklmnopqrstuvwxyz"),t||s||(r+="ABCDEFGHIJKLMNOPQRSTUVWXYZ");for(var c="",l=0;l<e;l++){c+=r[Math.round(Math.random()*(r.length-1))]}return c},S=n(3),A=n.n(S);const C=Object(i.Router)();C.post("/login",async(o,e)=>{const{email:n,password:s}=o.body,t=(await a.db().collection("private").find({email:n}).toArray())[0];t||o.status(202).json({result:"ERROR"});const r=await A.a.compare(s,t.password),c=!!r&&O.a.sign({_id:t._id},h.secretKey),l=r?"SUCCESS":"ERROR";e.status(200).json({result:l,token:c})}),C.post("/signup",async(o,e)=>{const{firstName:n,lastName:s,email:t,password:r}=o.body,c=D({length:22}),l=(await a.db().collection("private").find({email:t}).toArray())[0],i=await A.a.genSalt(10),u=await A.a.hash(r,i);l?e.status(202).json({result:"EXISTS"}):(await a.db().collection("private").insertOne({_id:c,email:t,password:u}),await a.db().collection("public").insertOne({_id:c,firstName:n,lastName:s}),e.status(200).json({result:"SUCCESS"}))}),C.get("/check_auth",async(o,e)=>{const{token:n}=o.query;try{const o=O.a.verify(n,h.secretKey);e.status(200).json(o)}catch(o){e.status(200).json()}});var _=C;const P=u()();P.use(f()()),P.use(d.a.urlencoded({extended:!1})),P.use(d.a.json()),P.get("/",(o,e)=>{e.status(200).json({result:"updated"})}),P.use(v),P.use(y),P.use(w),P.use("/account",_);var x=P,M=n(4),j=n.n(M),E=n(8),N=n(9),R=n.n(N);if(j.a.isMaster&&r.production){console.clear(),console.log(`Master ${process.pid} is running..`),r.display();for(var T=0;T<Object(E.cpus)().length;T++)j.a.fork();j.a.on("exit",(o,e,n)=>{console.log(`worker ${o.process.pid} died`)})}else{const o=R.a.createServer(x);a.init(),o.listen(r.port,r.host,()=>{const o=r.production?`Worker ${process.pid} listening on port ${r.port}`:`Server started on ${r.host}:${r.port}`;r.production||console.clear(),console.log(o),r.production||r.display()})}}]);
//# sourceMappingURL=app.js.map