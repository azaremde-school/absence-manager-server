!function(o){var e={};function n(t){if(e[t])return e[t].exports;var s=e[t]={i:t,l:!1,exports:{}};return o[t].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=o,n.c=e,n.d=function(o,e,t){n.o(o,e)||Object.defineProperty(o,e,{enumerable:!0,get:t})},n.r=function(o){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(o,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(o,"__esModule",{value:!0})},n.t=function(o,e){if(1&e&&(o=n(o)),8&e)return o;if(4&e&&"object"==typeof o&&o&&o.__esModule)return o;var t=Object.create(null);if(n.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:o}),2&e&&"string"!=typeof o)for(var s in o)n.d(t,s,function(e){return o[e]}.bind(null,s));return t},n.n=function(o){var e=o&&o.__esModule?function(){return o.default}:function(){return o};return n.d(e,"a",e),e},n.o=function(o,e){return Object.prototype.hasOwnProperty.call(o,e)},n.p="",n(n.s=10)}([function(o,e){o.exports=require("jsonwebtoken")},function(o,e){o.exports=require("dotenv")},function(o,e){o.exports=require("express")},function(o,e){o.exports=require("bcrypt")},function(o,e){o.exports=require("cluster")},function(o,e){o.exports=require("body-parser")},function(o,e){o.exports=require("mongodb")},function(o,e){o.exports=require("cookie-parser")},function(o,e){o.exports=require("os")},function(o,e){o.exports=require("http")},function(o,e,n){"use strict";n.r(e);var t=n(1);class s{static display(){console.log("<------------Config------------\x3e"),console.log("Production: "+s.production),console.log("Log: "+s.log),console.log("Port: "+s.port),console.log("Host: "+s.host),console.log("Secret key: "+s.secretKey),console.log("MongoDB username: "+s.mongodbUser),console.log("MongoDB password: "+s.mongodbPassword),console.log("Allowed domains count: "+s.allowedDomainsCount),console.log("Allowed domains: "+s.allowedDomains),console.log("App key: "+s.appKey),console.log("<------------Config-----------/>")}static init(){Object(t.config)({path:".env"}),s.production="true"===process.env.PRODUCTION,s.log="true"===process.env.LOG,s.port=process.env.PORT||3e3,s.host=process.env.HOST||"localhost",s.secretKey=process.env.SECRET_KEY||"",s.mongodbUser=process.env.MONGODB_USER||"",s.mongodbPassword=process.env.MONGODB_PASSWORD||"",s.allowedDomainsCount=process.env.ALLOWED_DOMAINS_COUNT||0,s.allowedDomains=[];for(var o=0;o<s.allowedDomainsCount;o++)s.allowedDomains.push(process.env["ALLOWED_DOMAIN_"+o]);s.appKey=process.env.APP_KEY||""}}s.init();var r=s,a=n(6);class c{static db(){return c.client.db("absence-manager")}static init(){const o=`mongodb+srv://${r.mongodbUser}:${r.mongodbPassword}@cluster0-oxkrf.mongodb.net/test?retryWrites=true&w=majority`;c.client=new a.MongoClient(o,{useNewUrlParser:!0,useUnifiedTopology:!0,poolSize:100}),c.client.connect()}}var i=c,l=n(2),u=n.n(l),d=n(5),p=n.n(d),g=n(7),f=n.n(g);var b=function(o,e,n){const t=o.get("origin")||"",s=o.headers["app-key"],a=!!t&&r.allowedDomains.includes(t),c=!!s&&r.appKey===s;a?(o.clientType=0,o.origin=t):c&&(o.clientType=1),(a||c)&&n()};var m=function(o,e,n){0===o.clientType?e.header("Access-Control-Allow-Origin",o.origin):e.header("Access-Control-Allow-Origin","*"),e.header("Access-Control-Allow-Credentials","true"),e.header("Access-Control-Allow-Headers","*"),n()},y=n(0),v=n.n(y);var O=function(o,e,n){const t=function(o){try{const e=v.a.verify(o,r.secretKey);return!!e&&e._id}catch(o){return!1}}(o.headers.token);o.auth=t,n()};class w{static display(){console.log("<------------Config------------\x3e"),console.log("Production: "+w.production),console.log("Log: "+w.log),console.log("Port: "+w.port),console.log("Host: "+w.host),console.log("Secret key: "+w.secretKey),console.log("MongoDB username: "+w.mongodbUser),console.log("MongoDB password: "+w.mongodbPassword),console.log("Allowed domains count: "+w.allowedDomainsCount),console.log("Allowed domains: "+w.allowedDomains),console.log("App key: "+w.appKey),console.log("<------------Config-----------/>")}static init(){Object(t.config)({path:".env"}),w.production="true"===process.env.PRODUCTION,w.log="true"===process.env.LOG,w.port=process.env.PORT||3e3,w.host=process.env.HOST||"localhost",w.secretKey=process.env.SECRET_KEY||"",w.mongodbUser=process.env.MONGODB_USER||"",w.mongodbPassword=process.env.MONGODB_PASSWORD||"",w.allowedDomainsCount=process.env.ALLOWED_DOMAINS_COUNT||0,w.allowedDomains=[];for(var o=0;o<w.allowedDomainsCount;o++)w.allowedDomains.push(process.env["ALLOWED_DOMAIN_"+o]);w.appKey=process.env.APP_KEY||""}}w.init();var h=w;var _=function(o){const{length:e,noNumbers:n,noLetters:t,noCapitalized:s}=o;var r="";n||(r+="1234567890"),t||(r+="abcdefghigklmnopqrstuvwxyz"),s||t||(r+="ABCDEFGHIJKLMNOPQRSTUVWXYZ");for(var a="",c=0;c<e;c++){a+=r[Math.round(Math.random()*(r.length-1))]}return a},S=n(3),D=n.n(S);const A=Object(l.Router)();A.post("/login",async(o,e)=>{const{email:n,password:t}=o.body,s=(await i.db().collection("private").find({email:n}).toArray())[0];if(!s)return void e.status(202).json({result:"ERROR"});const r=await D.a.compare(t,s.password),a=!!r&&v.a.sign({_id:s._id},h.secretKey,{expiresIn:"24h"}),c=r?"SUCCESS":"ERROR";e.status(200).json({result:c,token:a})}),A.post("/signup",async(o,e)=>{const{firstName:n,lastName:t,email:s,password:r}=o.body;if((await i.db().collection("private").find({email:s}).toArray())[0])return void e.status(202).json({result:"EXISTS"});const a=_({length:22}),c=await D.a.genSalt(10),l=await D.a.hash(r,c);await i.db().collection("private").insertOne({_id:a,email:s,password:l}),await i.db().collection("public").insertOne({_id:a,firstName:n,lastName:t}),e.status(200).json({result:"SUCCESS"})}),A.get("/check_auth",async(o,e)=>{const{token:n}=o.query;try{const o=v.a.verify(n,h.secretKey);e.status(200).json(o)}catch(o){e.status(200).json()}});var C=A;const j=Object(l.Router)();j.post("/add_group",async(o,e)=>{const{group:n}=o.body,t=o.auth;t?(n._id+=t,await i.db().collection("groups").insertOne({...n,owner:t}),e.status(200).json({result:"SUCCESS"})):e.status(200).json({result:"ERROR"})}),j.post("/add_absence",async(o,e)=>{const{groupId:n,memberId:t,absence:s}=o.body,r=o.auth;if(!r)return void e.status(200).json({result:"ERROR"});const a=n+r,c=(await i.db().collection("groups").aggregate([{$match:{_id:a}},{$project:{index:{$indexOfArray:["$members._id",t]}}}]).toArray())[0].index;var l=!1;const u=(await i.db().collection("groups").find({_id:a}).toArray())[0];if(u){const o=u.members.find(o=>o._id===t);o&&(l=!!o.absences.find(o=>o.date===s.date))}l&&await i.db().collection("groups").updateOne({_id:a},{$pull:{[`members.${c}.absences`]:{date:s.date}}}),await i.db().collection("groups").updateOne({_id:a},{$push:{[`members.${c}.absences`]:s}}),e.status(200).json({result:"SUCCESS"})}),j.get("/get_groups",async(o,e)=>{const n=o.auth;if(!n)return void e.status(200).json({result:"ERROR"});const t=await i.db().collection("groups").find({owner:n}).toArray();for(var s=0;s<t.length;s++)t[s]._id=parseInt(t[s]._id.replace(t[s].owner,""));e.status(200).json(t)});var R=j;const x=u()();x.use(f()()),x.use(p.a.urlencoded({extended:!1})),x.use(p.a.json()),x.get("/",(o,e)=>{e.status(200).json({result:"updated"})}),x.use(b),x.use(m),x.use(O),x.use("/account",C),x.use("/logic",R);var P=x,E=n(4),M=n.n(E),N=n(8),T=n(9),U=n.n(T);if(M.a.isMaster&&r.production){console.clear(),console.log(`Master ${process.pid} is running..`),r.display();for(var K=0;K<Object(N.cpus)().length;K++)M.a.fork();M.a.on("exit",(o,e,n)=>{console.log(`worker ${o.process.pid} died`)})}else{const o=U.a.createServer(P);i.init(),o.listen(r.port,r.host,()=>{const o=r.production?`Worker ${process.pid} listening on port ${r.port}`:`Server started on ${r.host}:${r.port}`;r.production||console.clear(),console.log(o),r.production||r.display()})}}]);
//# sourceMappingURL=app.js.map